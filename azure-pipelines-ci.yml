# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- none

resources:
- repo: self

variables:
  # Container registry service connection established during pipeline creation
- name: version
  value: '$(Build.BuildId)'
  # Agent VM image name
- name: vmImageName
  value: 'windows-latest'
- name: fullBuild
  value: $[ne(variables['Build.Reason'], 'PullRequest')]
- name: versionMajor
  value: 1
- name: versionMinor
  value: $[format('{0:yyMM}', pipeline.startTime)]
- name: hydraVersionCode
  value: $(Build.BuildId)
- name: hydraVersion
  value: $[counter(format('{0}.{1}.{2}', variables['versionMajor'], variables['versionMinor'], eq(variables['build.reason'], 'PullRequest')), 1)]

stages:
- stage: Build
  displayName: Build and push stage
  jobs:
  - job: Build
    displayName: Build
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '18.x'
    - task: Npm@1
      inputs:
        command: 'install'
        workingDir: 'react'
    - task: Npm@1
      inputs:
        command: 'custom'
        workingDir: 'react'
        customCommand: 'run pub'
    - task: PowerShell@2
      displayName: Generate Env File
      inputs:
        targetType: 'inline'
        script: |
          New-Item -Path common/src/test/resources -Name ".env" -ItemType "file" -Value "BLOB_CONNECTION_STRING = $(BLOB_CONNECTION_STRING)"
        workingDirectory: '$(Build.Repository.LocalPath)'
      condition: eq(variables.fullBuild, 'false')
    - task: PowerShell@2
      displayName: Set center/agent version
      inputs:
        targetType: 'inline'
        script: |
          $PSDefaultParameterValues['*:Encoding'] = 'utf8'
          $hydraVersionCode = $(Build.BuildId)
          $hydraVersion = "$(Build.SourceBranchName).$(Build.BuildId)"
          $branchName =  "$(Build.SourceBranch)"
          
          (Get-Content agent/src/main/resources/version.properties) -Replace '1000000', "$hydraVersionCode"| Set-Content agent/src/main/resources/version.properties
          (Get-Content center/src/main/resources/version.properties) -Replace '1000000', "$hydraVersionCode"| Set-Content center/src/main/resources/version.properties
          
          if($branchName -like '*Release*'){
            (Get-Content agent/src/main/resources/version.properties) -Replace '0.0.0', $hydraVersion| Set-Content agent/src/main/resources/version.properties
            (Get-Content center/src/main/resources/version.properties) -Replace '0.0.0', $hydraVersion| Set-Content center/src/main/resources/version.properties
          }
          echo "##vso[task.setvariable variable=hydraVersionCode;]$hydraVersionCode"
          echo "##vso[task.setvariable variable=hydraVersion;]$hydraVersion"
        workingDirectory: '$(Build.Repository.LocalPath)'
      condition: eq(variables.fullBuild, 'true')
    - task: Gradle@3
      displayName: Run JUnit Test
      inputs:
        gradleWrapperFile: 'gradlew'
        tasks: 'test jacocoRootReport'
        publishJUnitResults: true
        testResultsFiles: '**/TEST-*.xml'
        #codeCoverageToolOption: 'JaCoCo'
        #codeCoverageClassFilesDirectories: 'build/classes/java/main'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '1.11'
        sonarQubeRunAnalysis: false
        spotBugsAnalysis: false
      condition: eq(variables.fullBuild, 'false')
    - task: PowerShell@2
      displayName: Delete Env File
      inputs:
        targetType: 'inline'
        script: |
          Remove-Item -Path common/src/test/resources/.env -Force
        workingDirectory: '$(Build.Repository.LocalPath)'
      condition: eq(variables.fullBuild, 'false')
    - task: PublishCodeCoverageResults@1
      displayName: Publich Code Coverage
      inputs:
        codeCoverageTool: 'JaCoCo'
        summaryFileLocation: 'build/reports/jacoco/jacocoRootReport/*.xml'
        reportDirectory: 'build/reports/jacoco/jacocoRootReport/html'
      condition: eq(variables.fullBuild, 'false')
    - task: Gradle@2
      displayName: Build center
      inputs:
        gradleWrapperFile: 'gradlew'
        tasks: 'center:bootJar'
        publishJUnitResults: false
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '1.11'
        sonarQubeRunAnalysis: false
        spotBugsAnalysis: false
    - task: Gradle@2
      displayName: Build agent
      inputs:
        gradleWrapperFile: 'gradlew'
        tasks: 'agent:bootJar'
        publishJUnitResults: false
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '1.11'
        sonarQubeRunAnalysis: false
        spotBugsAnalysis: false
    - task: CopyFiles@2
      displayName: Copy deploy center files
      inputs:
        SourceFolder: 'center/'
        Contents: 'Dockerfile'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/center_deploy'
      condition: eq(variables.fullBuild, 'true')
    - task: CopyFiles@2
      displayName: Copy deploy center files 2
      inputs:
        SourceFolder: 'center/deploy_startup/'
        Contents: '**'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/center_deploy/deploy_startup'
      condition: eq(variables.fullBuild, 'true')
    - task: CopyFiles@2
      displayName: Copy center jar
      inputs:
        SourceFolder: 'center/build/libs/'
        Contents: '*.jar'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/center_deploy'
      condition: eq(variables.fullBuild, 'true')
    - task: Gradle@2
      displayName: Package Mac installer
      inputs:
        gradleWrapperFile: 'gradlew'
        tasks: 'packageMacInstaller'
        publishJUnitResults: false
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '1.11'
        sonarQubeRunAnalysis: false
        spotBugsAnalysis: false
      condition: eq(variables.fullBuild, 'true')
    - task: Gradle@2
      displayName: Package Windows installer
      inputs:
        gradleWrapperFile: 'gradlew'
        tasks: 'packageWindowsInstaller'
        publishJUnitResults: false
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '1.11'
        sonarQubeRunAnalysis: false
        spotBugsAnalysis: false
      condition: eq(variables.fullBuild, 'true')
    - task: Gradle@2
      displayName: Package Android client APK
      inputs:
        workingDirectory: 'android_client'
        gradleWrapperFile: 'android_client/gradlew'
        tasks: 'assembleRelease'
        publishJUnitResults: false
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '1.11'
        options: '-PclientVersionCode=$(hydraVersionCode) -PclientVersionNumber=$(hydraVersion)'
    - task: PublishPipelineArtifact@1
      displayName: 'Publish Artifact: Production APK'
      inputs:
        targetPath: 'android_client/app/build/outputs/apk/release/app-release.apk'
        ArtifactName: HydraLabRelease
    - task: PublishPipelineArtifact@1
      displayName: 'Publish Artifact: Production APK'
      inputs:
        targetPath: 'android_client/app/build/outputs/mapping/release/mapping.txt'
        ArtifactName: HydraLabRelease
    - task: CopyFiles@2
      displayName: Copy agent jar
      inputs:
        SourceFolder: 'agent/build/libs/'
        Contents: '*.jar'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/agent_deploy'
      condition: eq(variables.fullBuild, 'true')
    - task: CopyFiles@2
      displayName: Copy agent installer
      inputs:
        SourceFolder: 'build/installer/'
        Contents: '*.zip'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/agent_deploy'
      condition: eq(variables.fullBuild, 'true')
    - task: CopyFiles@2
      displayName: Copy deploy uber files
      inputs:
        SourceFolder: 'center/uber_image/'
        Contents: '**'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/uber_image'
      condition: eq(variables.fullBuild, 'true')
    - task: PowerShell@2
      displayName: Add Release Tag
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "##vso[build.addbuildtag]Release"
        workingDirectory: '$(Build.Repository.LocalPath)'
      condition: and(eq(variables.fullBuild, 'true'), contains(variables['Build.SourceBranch'], 'Release/'))
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'HydraLabRelease'
        publishLocation: 'Container'
      condition: eq(variables.fullBuild, 'true')